---
- name: Install zsh
  apt:
    name: zsh
    state: present

# - name: Download ohmyzsh
#   get_url:
#     url: https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh
#     dest: /tmp/ohmyzsh.sh
#     mode: 0777

- name: Install ohmyzsh
  become: true
  become_user: '{{ username }}'
  ignore_errors: true # will exit with non-zero return code if already installed.
  script:
    cmd: https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh

- name: Install zsh-autosuggestions
  become: true
  become_user: '{{ username }}'
  git:
    repo: https://github.com/zsh-users/zsh-autosuggestions
    dest: '/home/{{ username }}/.oh-my-zsh/custom/plugins/zsh-autosuggestions'

- name: Check if zsh-autosuggestions is already in zshrc
  shell: "cat /home/{{ username }}/.zshrc | grep -c 'zsh-autosuggestions'"
  register: zsh_autosuggestions_registered
- name: Add zsh-autosuggestions to zshrc plugins
  when: zsh_autosuggestions_registered == 0
  replace:
    path: '/home/{{ username }}/.zshrc'
    regexp: 'plugins\s*=\s*\('
    replace: 'plugins=(zsh-autosuggestions '

- name: Install preferred terminal emulator
  apt:
    name: '{{ terminal }}'
    state: present

- name: Set default shell
  become: true
  become_user: '{{ username }}'
  user:
    name: '{{ username }}'
    shell: '{{ default_shell }}'
